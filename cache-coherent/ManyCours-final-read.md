# 1.Abstract

12核的AMD Opteron 处理器 Mangny Cours 结合了在silicon，packaging，interconnect，缓存一致性协议和服务器架构的发展，在和前几代AMD Opteron有相同功率的情况下，显著地提高了high volume commodity 2P/4P blade servers的计算密度。该处理器使用tightly coupled MCM配置package两个6核的die来生产一个12核的处理器架构，该架构可以使用4P配置拓展为48核。在大多种工作负载中达成近乎线性的性能提升要求即使在高带宽负载下，缓存层次和内存子系统仍支持访存的低延迟。为了这个目的，Magny Cours的一个关键的有条件完成的特点就是探测过滤器，它降低了传统基于一致性的广播带宽开销，也降低了访存延迟。一个新型的L3设计完成了两个不同的功能：1. 传统的和处理器相关的缓存，2.存储缓存目录，这开拓了L3和内存控制器在同一个die上相同位置的事实，该L3用快速的SRAM实现，和内存控制器相关。

# 2.Processor Overview

### 2.1 "Magny Cours" die(node)

每个核有独立的指令缓存和数据缓存，每个的大小为64kB，下一级为片上的512kB的L2缓存。每个缓存（包括L3）的缓存行大小为64B。L1缓存为2路组相联，load-to-use的延迟为3时钟周期。L2缓存为16路组相联，load-to-use的延迟为12时钟周期。L1缓存和L2缓存采用不相容策略：L2缓存保存L1中被替换出的行，L2中命中的行被无效然后放到L1缓存中。

该处理器的实现允许探测过滤器在多处理器配置下enable，在不需要它的单处理器的桌面和工作站配置下disable。

探测过滤器也叫做HyperTransport Assit或者HT Assit。它有两个好处：1.保留系统带宽，2.降低访存延迟。

### 2.2 MCM package

### 2.3 2P/4P blade architectures

### 2.4 Configurable L3 cache

##### 2.4.1 L3 cache organization

L3 cache保留从L2 cache中被替换出的行。6MB的L3缓存由两个1MB和两个2MB的16路组相联的子缓存组成。缓存探测操作可以并行地在所有子缓存上执行，或者被限制到一个明确的基于地址的子集。缓存行被分配到可用的子缓存，导致了基于地址的限制和对索引集中含有无效项的子缓存的偏爱。如果没有无效的路，那么一个与它们的大小成比例的加权轮询调度算法分配缓存行。在一个有效的替换，首先选择保存替换行的子缓存（使用加权轮询调度），然后应用一个假的LRU算法在16路相关子缓存中选择保存替换行的缓存行。

缓存支持”直接寻址“模式，在该模式下L3可以基于地址分片。在该模式下，分配的行和探头基于对地址位的哈希被导向一半的缓存（一对子缓存）。这样可以降低功耗并有可能降低延迟。每个tag探头ties up一部分缓存的资源，这允许更多的投机的读取并行地发射。然而，一些应用可能对该模式下降低的有效关联性敏感，所以这个益处是依赖于工作负载种类的。

L3作为一个victim的优点是降低了L2和L3 cache的内容重复，允许更多数据被缓存。另外，当L3缓存行被替换出去时不用再无效L2 cache中的缓存行。当L3一个缓存行被检测为true sharing时，那么当L3提供该行的副本给请求的核时，L3 缓存可以保留该行。如果下次读来自分配该L3缓存行的核，那么这个数据被认为是私有的并且L3不保存一个副本，而是把该行送回到core负责，设置该行为E或者M状态，然后无效L3缓存中的该行。否则，如果和core请求类型一致，L3会继续保留副本，因为预期会有share。这个机制允许一个core替换出E和M状态的行，然后以相同状态保留在L3缓存，如果没有被共享的话。

##### 2.4.2 Sub-Cache organization

控制信号到数据区域和读数据返回路径都流水线化，导致到后继区域的round-trip延迟增加了一个时钟周期。因此，子缓存可以提供4个连续的128位值，即使最后一个值可能在一个离tag很远的位置。

##### 2.4.3 Latency optimation

L3缓存架构动态地优化延迟和带宽。当缓存被lightly加载时，它处于延迟降低模式，在该模式下，处理器发起的tag探测假定命中并且需要的数据总线和buffer提前保留。这样允许tag探测的结果直接读数据宏并且减小延迟。然而，当请求频率很高并且L3不包含足够的资源，请求被发送到tags作为”query only“，这会决定缓存状态而不发起一个数据传输。如果该行不在cache中，请求会以最小延迟发到DRAM。否则，包含该行的L3 数据读命令被发送到子缓存中一旦需要的资源可用。



























